<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jewelry Quote - Online Test Page</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="h1">Online Test Page (Web Version)</div>
        <div class="sub">
          Used to verify: <b>Diameter(mm)→ct Estimate</b>, <b>Gem Treatment Multiplier</b>, <b>Diamond 4C Auto
            Price</b>, and Total Formula (Cost/Profit/Tax).
          <br />You can also write your real price catalog into <span class="mono">app.js</span>, then use these test
          cases for regression testing.
        </div>
      </div>
      <div class="nav">
        <a href="./index.html">⬅️ Back to Quote Page</a>
      </div>
    </div>

    <div class="card">
      <h2>Run Tests</h2>
      <div class="btnrow">
        <button id="btnRun">Run All Tests</button>
        <button class="secondary" id="btnFillDemo">Write "Demo Quote" to Calculator & Redirect</button>
      </div>
      <div class="small">Note: Test prices depend on built-in sample catalog; if you modified the catalog, expected
        values may need adjustment.</div>
    </div>

    <div class="card">
      <h2>Test Results</h2>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Case</th>
            <th>Check Item</th>
            <th>Expected</th>
            <th>Actual</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Explanation</h2>
      <div class="small">
        <b>mm→ct:</b> Uses common "Round Diamond Diameter" table interpolation (suitable for quick side stone
        quote).<br />
        <b>Diamond 4C:</b> Sample price table gives price/ct by carat bracket + color + clarity, then multiplies by
        cut/fluor.<br />
        <b>Gem Treatment:</b> Sample multipliers: Heated×0.90, Unheated×1.25, Glass Filled×0.45 etc. (All adjustable).
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
  <script>
    const { CATALOG, interpolateMeleeCt, diamondAutoPricePerCt } = window.__JQ;

    function approxEqual(a, b, eps = 0.01) {
      return Math.abs(a - b) <= eps;
    }

    function addRow(tbody, name, check, exp, act, ok) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td>${check}</td>
        <td class="mono">${exp}</td>
        <td class="mono">${act}</td>
        <td>${ok ? '<span class="pass">PASS</span>' : '<span class="fail">FAIL</span>'}</td>
      `;
      tbody.appendChild(tr);
    }

    function run() {
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";

      // Case 1: mm->ct known point
      {
        const mm = 1.3;
        const ct = interpolateMeleeCt(mm);
        // from table 1.3 => 0.010
        addRow(tbody, "T1", "mm→ct(1.3mm)", "0.0100", ct.toFixed(4), approxEqual(ct, 0.01, 0.0006));
      }

      // Case 2: mm interpolation between 2.0 (0.035) and 2.1 (0.04) => at 2.05 ~ 0.0375
      {
        const mm = 2.05;
        const ct = interpolateMeleeCt(mm);
        addRow(tbody, "T2", "mm→ct(2.05mm Interp)", "0.0375", ct.toFixed(4), approxEqual(ct, 0.0375, 0.0008));
      }

      // Case 3: Diamond auto price example (1.00ct, G-H, VS, Excellent, None)
      {
        const p = diamondAutoPricePerCt({ carat: 1.00, color: "G-H", clarity: "VS", cutIndex: 0, fluorIndex: 0 });
        // base for 1.00-1.49, G-H, VS = 6000; Excellent mult 1.08 => 6480
        addRow(tbody, "T3", "Diamond Auto Price/ct", "6480.00", p.toFixed(2), approxEqual(p, 6480, 0.1));
      }

      // Case 4: Diamond fluorescent strong (multiply 0.92) => 6480*0.92 = 5961.6
      {
        const p = diamondAutoPricePerCt({ carat: 1.00, color: "G-H", clarity: "VS", cutIndex: 0, fluorIndex: 3 });
        addRow(tbody, "T4", "Diamond Fluor Mult", "5961.60", p.toFixed(2), approxEqual(p, 5961.6, 0.2));
      }

      // Case 5: Colored gem treatment multiplier (Sapphire AA base 260, No Heat x1.25 => 325)
      {
        const sapphire = CATALOG.coloredGems.find(g => g.key === "sapphire");
        const base = sapphire.grades.find(x => x.grade === "AA").p; // 260
        const mult = CATALOG.treatments.find(t => t.key === "unheated").mult; // 1.25
        const p = base * mult;
        addRow(tbody, "T5", "Gem Treat Mult(Unheated)", "325.00", p.toFixed(2), approxEqual(p, 325, 0.01));
      }

      // Case 6: End-to-end cost formula (simple)
      // stones: 1.25ct sapphire AA natural => 1.25*260=325
      // metal: 5g 18k ppg=70 loss 3% => 5*1.03*70=360.5
      // labor: 100+200+0+0 = 300
      // pack: 20+10=30
      // cost=1016? Wait compute: 325+360.5+300+30 = 1015.5
      // profit 20% => 1218.6
      // tax 8% => 1316.088 => 1316.09
      {
        const stones = 1.25 * 260;
        const metal = 5 * 1.03 * 70;
        const labor = 300;
        const pack = 30;
        const cost = stones + metal + labor + pack;
        const quote = cost * 1.2 * 1.08;
        addRow(tbody, "T6", "Total Formula(Cost)", "1015.50", cost.toFixed(2), approxEqual(cost, 1015.50, 0.01));
        addRow(tbody, "T6", "Total Formula(Quote)", "1316.09", quote.toFixed(2), approxEqual(quote, 1316.09, 0.02));
      }
    }

    document.getElementById("btnRun").addEventListener("click", run);

    document.getElementById("btnFillDemo").addEventListener("click", () => {
      // Write demo state into localStorage, then open index
      const demo = {
        quoteNo: "DEMO-" + (new Date().toISOString().slice(0, 10)),
        customerName: "Demo Customer",
        productName: "18K Sapphire Ring (Sample)",
        currency: "USD",
        stones: [
          // main sapphire 1.25ct, AA, unheated
          {
            id: "DEMO1", roleIndex: 0, typeKey: "sapphire", weightMode: 0, totalCt: "1.25",
            ctEach: "", qty: "1", mm: "",
            gradeIndex: 1, treatmentKey: "unheated",
            dColor: "G-H", dClarity: "VS", dCutIndex: 0, dFluorIndex: 0,
            priceMode: 0, pricePerCt: "", sub: "0.00"
          },
          // side diamonds 1.3mm x 80
          {
            id: "DEMO2", roleIndex: 1, typeKey: "diamond", weightMode: 2, totalCt: "",
            ctEach: "", qty: "80", mm: "1.3",
            gradeIndex: 0, treatmentKey: "natural_unknown",
            dColor: "G-H", dClarity: "SI", dCutIndex: 1, dFluorIndex: 0,
            priceMode: 0, pricePerCt: "", sub: "0.00"
          }
        ],
        metal: { materialKey: "18k", weightG: "5.00", priceMode: 0, pricePerGram: "", lossRate: "3", extraFee: "15" },
        labor: { designFee: "100", moldFee: "200", makingFee: "180", reworkFee: "0" },
        pack: { packFee: "25", certFee: "10" },
        profitRate: "20",
        taxRate: "8"
      };
      localStorage.setItem("jewelry_quote_state_v1", JSON.stringify(demo));
      location.href = "./index.html";
    });

    // Auto run on load
    run();
  </script>
</body>

</html>